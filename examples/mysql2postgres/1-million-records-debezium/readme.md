To capture changes in data from a MySQL database, we'll utilize the `io.debezium.connector.mysql.MySql` Connector provided by Debezium.   
After capturing the data, we'll transfer it to a Postgres database using the `io.confluent.connect.jdbc.JdbcSinkConnector` connector class will act as the sink connector for the Postgres database.

## Table structure.

```bash
+---------+---------------+------+-----+-------------------+-------------------+
| Field   | Type          | Null | Key | Default           | Extra             |
+---------+---------------+------+-----+-------------------+-------------------+
| id      | bigint        | NO   | PRI | NULL              |                   |
| name    | varchar(255)  | NO   |     | NULL              |                   |
| price   | decimal(10,2) | NO   |     | NULL              |                   |
| weight  | double        | YES  |     | NULL              |                   |
| created | timestamp     | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+---------+---------------+------+-----+-------------------+-------------------+
```

### Source and Target Databases.

`mysql-source` database image is based on `slotix/dbs-mysql:8`, which has all the necessary settings to enable MySQL CDC replication. This image also contains the `initdb.sql` script, which creates table with the above structure.   
We will populate the 'products' source table with random data generated by the script below.

`postgres-target` database is based on the official `postgres:15-alpine` image. `postgres-target` database will receive all changes made to the `mysql-source` database.

These databases are usually on different physical servers in a production environment. But in our example, we will run them on the same machine in different containers.


## Start.

```bash
export DEBEZIUM_VERSION=2.0
docker-compose up --build -d
```

### Deployment

#### Deploy of source connector to debezium.

```
curl -i -X POST -H "Accept:application/json" -H  "Content-Type:application/json" http://localhost:8083/connectors/ -d @source.json
```

#### Deploy of sink connector to debezium.

```
curl -i -X POST -H "Accept:application/json" -H  "Content-Type:application/json" http://localhost:8083/connectors/ -d @target.json
```

#### List of connectors.

Visit http://localhost:8083/connectors/ to view a list of active and running connectors.

### Populate source table with sample data.

To execute the SQL script that populates the source table with sample data, you can run the following commands:

```sql
docker compose exec -it \
    mysql-source \
    mysql -u root -p123456 -D source
```

In MySQL prompt, execute the following command

```sql
SELECT CURTIME();
INSERT INTO products (name, price, weight)
SELECT
  CONCAT('Product', number) AS name,
  ROUND(RAND() * 100, 2) AS price,
  RAND() * 10 AS weight
FROM
  (SELECT @row := @row + 1 AS number FROM
    (SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6
     UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10) t1,
    (SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6
     UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10) t2,
    (SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6
     UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10) t3,
    (SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6
     UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10) t4,
    (SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6
     UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10) t5,
    (SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6
     UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10) t6,
    (SELECT @row := 0) r
  ) numbers
LIMIT 1000000;
SELECT CURTIME();
```

The code consists of three SQL commands executed in order:

1. The first line `SELECT CURTIME();` retrieves the current time from the MySQL database server.
2. The next command will insert 1 million rows of random data into a table named `products`.
4. The final line `SELECT CURTIME();` retrieves the current time again.

### Verify the Record Count in the PostgreSQL Target.

```bash
docker compose  exec postgres-target bash -c 'psql -U $POSTGRES_USER $POSTGRES_DB -c "select count(*) from products"'
```

### Stop the demo
```
docker compose down --remove-orphans
```
